!function(e,t){function r(e){return e?n(e):void 0}function n(e){for(var t in r.prototype)e[t]=r.prototype[t];return e}function o(e){return 127>=e?[e]:2047>=e?[192|e>>6,128|63&e]:[224|e>>12,128|(4032&e)>>6,128|63&e]}function a(e){return 127>=e?1:2047>=e?2:3}function i(e,t){if(!t)return!1;for(var r in t){var n=t[r];switch(n.option){case"required":if("undefined"==typeof e[r])return!1;break;case"optional":"undefined"!=typeof e[r]&&t.__messages[n.type]&&i(e[r],t.__messages[n.type]);break;case"repeated":if(e[r]&&t.__messages[n.type])for(var o=0;o<e[r].length;o++)if(!i(e[r][o],t.__messages[n.type]))return!1}}return!0}function s(e,t,r,n){for(var o in n)if(r[o]){var a=r[o];switch(a.option){case"required":case"optional":t=h(e,t,f(a.type,a.tag)),t=c(n[o],a.type,t,e,r);break;case"repeated":n[o].length>0&&(t=u(n[o],a,t,e,r))}}return t}function c(e,t,r,n,o){var a=K.codec;switch(t){case"uInt32":r=h(n,r,a.encodeUInt32(e));break;case"int32":case"sInt32":r=h(n,r,a.encodeSInt32(e));break;case"float":h(n,r,a.encodeFloat(e)),r+=4;break;case"double":h(n,r,a.encodeDouble(e)),r+=8;break;case"string":var i=a.byteLength(e);r=h(n,r,a.encodeUInt32(i)),a.encodeStr(n,r,e),r+=i;break;default:if(o.__messages[t]){var c=new ArrayBuffer(a.byteLength(JSON.stringify(e))),i=0;i=s(c,i,o.__messages[t],e),r=h(n,r,a.encodeUInt32(i));for(var u=0;i>u;u++)n[r]=c[u],r++}}return r}function u(e,t,r,n,o){var a=0;if(util.isSimpleType(t.type))for(r=h(n,r,f(t.type,t.tag)),r=h(n,r,K.codec.encodeUInt32(e.length)),a=0;a<e.length;a++)r=c(e[a],t.type,r,n);else for(a=0;a<e.length;a++)r=h(n,r,f(t.type,t.tag)),r=c(e[a],t.type,r,n,o);return r}function h(e,t,r){for(var n=0;n<r.length;n++,t++)e[t]=r[n];return t}function f(e,t){var r=K.constants.TYPES[e]||2;return K.codec.encodeUInt32(t<<3|r)}function l(e,t,r){for(;J.offset<r;){var n=d(),o=(n.type,n.tag),a=t.__tags[o];switch(t[a].option){case"optional":case"required":e[a]=b(t[a].type,t);break;case"repeated":e[a]||(e[a]=[]),p(e[a],t[a].type,t)}}return e}function d(){var e=K.codec.decodeUInt32(v());return{type:7&e,tag:e>>3}}function b(e,t){var r=K.codec;switch(e){case"uInt32":return r.decodeUInt32(v());case"int32":case"sInt32":return r.decodeSInt32(v());case"float":var n=r.decodeFloat(J.buffer,J.offset);return J.offset+=4,n;case"double":var o=r.decodeDouble(J.buffer,J.offset);return J.offset+=8,o;case"string":var a=r.decodeUInt32(v()),i=r.decodeStr(J.buffer,J.offset,a);return J.offset+=a,i;default:if(t&&t.__messages[e]){var a=r.decodeUInt32(v()),s={};return l(s,t.__messages[e],J.offset+a),s}}}function p(e,t,r){if(O.isSimpleType(t))for(var n=K.codec.decodeUInt32(v()),o=0;n>o;o++)e.push(b(t));else e.push(b(t,r))}function v(e){var t=[],r=J.offset;e=e||!1;var n;do n=F[r],t.push(n),r++;while(n>=128);return e||(J.offset=r),t}r.prototype.on=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks[e]=this._callbacks[e]||[]).push(t),this},r.prototype.once=function(e,t){function r(){n.off(e,r),t.apply(this,arguments)}var n=this;return this._callbacks=this._callbacks||{},t._off=r,this.on(e,r),this},r.prototype.off=r.prototype.removeListener=r.prototype.removeAllListeners=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var r=this._callbacks[e];if(!r)return this;if(1==arguments.length)return delete this._callbacks[e],this;var n=index(r,t._off||t);return~n&&r.splice(n,1),this},r.prototype.emit=function(e){this._callbacks=this._callbacks||{};var t=[].slice.call(arguments,1),r=this._callbacks[e];if(r){r=r.slice(0);for(var n=0,o=r.length;o>n;++n)r[n].apply(this,t)}return this},r.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks[e]||[]},r.prototype.hasListeners=function(e){return!!this.listeners(e).length};var g=4,y=1,T=2,k=1,m=65535,_=1,I=7,E={Package:{TYPE_HANDSHAKE:1,TYPE_HANDSHAKE_ACK:2,TYPE_HEARTBEAT:3,TYPE_DATA:4,TYPE_KICK:5},Message:{TYPE_REQUEST:0,TYPE_NOTIFY:1,TYPE_RESPONSE:2,TYPE_PUSH:3}},P=E.Package,w=E.Message;E.strencode=function(e){for(var r=new t(3*e.length),n=0,o=0;o<e.length;o++){var a=e.charCodeAt(o),i=null;i=127>=a?[a]:2047>=a?[192|a>>6,128|63&a]:[224|a>>12,128|(4032&a)>>6,128|63&a];for(var s=0;s<i.length;s++)r[n]=i[s],++n}var c=new t(n);return S(c,0,r,0,n),c},E.strdecode=function(e){for(var r=new t(e),n=[],o=0,a=0,i=r.length;i>o;)r[o]<128?(a=r[o],o+=1):r[o]<224?(a=((63&r[o])<<6)+(63&r[o+1]),o+=2):(a=((15&r[o])<<12)+((63&r[o+1])<<6)+(63&r[o+2]),o+=3),n.push(a);return String.fromCharCode.apply(null,n)},P.encode=function(e,r){var n=r?r.length:0,o=new t(g+n),a=0;return o[a++]=255&e,o[a++]=n>>16&255,o[a++]=n>>8&255,o[a++]=255&n,r&&S(o,a,r,0,n),o},P.decode=function(e){var r=new t(e),n=r[0],o=1,a=(r[o++]<<16|r[o++]<<8|r[o++])>>>0,i=a?new t(a):null;return S(i,0,r,g,a),{type:n,body:i}},w.encode=function(e,r,n,o,a){var i=A(r)?C(e):0,s=y+i;if(Y(r))if(n){if("number"!=typeof o)throw new Error("error flag for number route!");s+=T}else if(s+=k,o){if(o=E.strencode(o),o.length>255)throw new Error("route maxlength is overflow");s+=o.length}a&&(s+=a.length);var c=new t(s),u=0;return u=U(r,n,c,u),A(r)&&(u=N(e,i,c,u)),Y(r)&&(u=H(n,o,c,u)),a&&(u=D(a,c,u)),c},w.decode=function(e){var r=new t(e),n=r.length||r.byteLength,o=0,a=0,i=null,s=r[o++],c=s&_,u=s>>1&I;if(A(u)){var h=r[o++];for(a=127&h;128&h;)a<<=7,h=r[o++],a|=127&h}if(Y(u))if(c)i=r[o++]<<8|r[o++];else{var f=r[o++];f?(i=new t(f),S(i,0,r,o,f),i=E.strdecode(i)):i="",o+=f}var l=n-o,d=new t(l);return S(d,0,r,o,l),{id:a,type:u,compressRoute:c,route:i,body:d}};var S=function(e,t,r,n,o){if("function"==typeof r.copy)r.copy(e,t,n,n+o);else for(var a=0;o>a;a++)e[t++]=r[n++]},A=function(e){return e===w.TYPE_REQUEST||e===w.TYPE_RESPONSE},Y=function(e){return e===w.TYPE_REQUEST||e===w.TYPE_NOTIFY||e===w.TYPE_PUSH},C=function(e){var t=0;do t+=1,e>>=7;while(e>0);return t},U=function(e,t,r,n){if(e!==w.TYPE_REQUEST&&e!==w.TYPE_NOTIFY&&e!==w.TYPE_RESPONSE&&e!==w.TYPE_PUSH)throw new Error("unkonw message type: "+e);return r[n]=e<<1|(t?1:0),n+y},N=function(e,t,r,n){var o=n+t-1;for(r[o--]=127&e;o>=n;)e>>=7,r[o--]=127&e|128;return n+t},H=function(e,t,r,n){if(e){if(t>m)throw new Error("route number is overflow");r[n++]=t>>8&255,r[n++]=255&t}else t?(r[n++]=255&t.length,S(r,n,t,0,t.length),n+=t.length):r[n++]=0;return n},D=function(e,t,r){return S(t,r,e,0,e.length),r+e.length},K={};K.init=function(e){K.encoder.init(e.encoderProtos),K.decoder.init(e.decoderProtos)},K.encode=function(e,t){return K.encoder.encode(e,t)},K.decode=function(e,t){return K.decoder.decode(e,t)};var M={};M.TYPES={uInt32:0,sInt32:0,int32:0,"double":1,string:2,message:2,"float":5};var O={};O.isSimpleType=function(e){return"uInt32"===e||"sInt32"===e||"int32"===e||"uInt64"===e||"sInt64"===e||"float"===e||"double"===e};var R={},F=new ArrayBuffer(8),q=new Float32Array(F),B=new Float64Array(F),L=new Uint8Array(F);R.encodeUInt32=function(e){var e=parseInt(e);if(isNaN(e)||0>e)return null;var t=[];do{var r=e%128,n=Math.floor(e/128);0!==n&&(r+=128),t.push(r),e=n}while(0!==e);return t},R.encodeSInt32=function(e){var e=parseInt(e);return isNaN(e)?null:(e=0>e?2*Math.abs(e)-1:2*e,R.encodeUInt32(e))},R.decodeUInt32=function(e){for(var t=0,r=0;r<e.length;r++){var n=parseInt(e[r]);if(t+=(127&n)*Math.pow(2,7*r),128>n)return t}return t},R.decodeSInt32=function(e){var t=this.decodeUInt32(e),r=t%2===1?-1:1;return t=(t%2+t)/2*r},R.encodeFloat=function(e){return q[0]=e,L},R.decodeFloat=function(e,t){if(!e||e.length<t+4)return null;for(var r=0;4>r;r++)L[r]=e[t+r];return q[0]},R.encodeDouble=function(e){return B[0]=e,L.subarray(0,8)},R.decodeDouble=function(e,t){if(!e||e.length<8+t)return null;for(var r=0;8>r;r++)L[r]=e[t+r];return B[0]},R.encodeStr=function(e,t,r){for(var n=0;n<r.length;n++)for(var a=r.charCodeAt(n),i=o(a),s=0;s<i.length;s++)e[t]=i[s],t++;return t},R.decodeStr=function(e,t,r){for(var n=[],o=t+r;o>t;){var a=0;e[t]<128?(a=e[t],t+=1):e[t]<224?(a=((63&e[t])<<6)+(63&e[t+1]),t+=2):(a=((15&e[t])<<12)+((63&e[t+1])<<6)+(63&e[t+2]),t+=3),n.push(a)}for(var i="",s=0;s<n.length;)i+=String.fromCharCode.apply(null,n.slice(s,s+1e4)),s+=1e4;return i},R.byteLength=function(e){if("string"!=typeof e)return-1;for(var t=0,r=0;r<e.length;r++){var n=e.charCodeAt(r);t+=a(n)}return t};var x=K.encoder={};x.init=function(e){this.protos=e||{}},x.encode=function(e,t){var r=this.protos[e];if(!i(t,r))return null;var n=K.codec.byteLength(JSON.stringify(t)),o=new ArrayBuffer(n),a=new Uint8Array(o),c=0;return r&&(c=s(a,c,r,t),c>0)?a.subarray(0,c):null};var J=K.decoder={};J.buffer=0,J.offset=0,J.init=function(e){this.protos=e||{}},J.setProtos=function(e){e&&(this.protos=e)},J.decode=function(e,t){var r=this.protos[e];return J.buffer=t,J.offset=0,r?l({},r,F.length):null};var Q="js-websocket",W="0.0.5",j=200,z=501,G=function(){this.socket=null,this.callbacks={},this.handlers={},this.routeMap={},this.heartbeatInterval=0,this.heartbeatTimeout=0,this.nextHeartbeatTimeout=0,this.gapThreshold=100,this.heartbeatId=null,this.heartbeatTimeoutId=null,this.handshakeCallback=null,this.handshakeBuffer={sys:{type:Q,version:W},user:{}},this.initCallback=null,this.handlers[P.TYPE_HANDSHAKE]=this.handshake,this.handlers[P.TYPE_HEARTBEAT]=this.heartbeat,this.handlers[P.TYPE_DATA]=this.onData,this.handlers[P.TYPE_KICK]=this.onKick};e.Pomelo=G,G.reqId=0;var V=G.prototype;n(V),V.init=function(e,t){this.initCallback=t;var r=e.host,n=e.port,o="ws://"+r;n&&(o+=":"+n),this.handshakeBuffer.user=e.user,this.handshakeCallback=e.handshakeCallback,this.initWebSocket(o,t)},V.initWebSocket=function(e,t){console.log("connect to "+e);var r=this,n=function(e){var t=P.encode(P.TYPE_HANDSHAKE,E.strencode(JSON.stringify(r.handshakeBuffer)));r.send(t)},o=function(e){r.processPackage(P.decode(e.data),t),r.heartbeatTimeout&&(r.nextHeartbeatTimeout=Date.now()+r.heartbeatTimeout)},a=function(e){r.emit("io-error",e),console.error("socket error: ",e)},i=function(e){r.emit("close",e),console.error("socket close: ",e)};this.socket=new WebSocket(e),this.socket.binaryType="arraybuffer",this.socket.onopen=n,this.socket.onmessage=o,this.socket.onerror=a,this.socket.onclose=i},V.disconnect=function(){var e=this.socket;e&&(e.disconnect&&e.disconnect(),e.close&&e.close(),console.log("disconnect"),this.socket=null),this.heartbeatId&&(clearTimeout(this.heartbeatId),this.heartbeatId=null),this.heartbeatTimeoutId&&(clearTimeout(this.heartbeatTimeoutId),this.heartbeatTimeoutId=null)},V.request=function(e,t,r){2===arguments.length&&"function"==typeof t?(r=t,t={}):t=t||{},e=e||t.route,e&&(G.reqId++,this.sendMessage(G.reqId,e,t),this.callbacks[G.reqId]=r,this.routeMap[G.reqId]=e)},V.notify=function(e,t){t=t||{},this.sendMessage(0,e,t)},V.sendMessage=function(e,t,r){var n=e?w.TYPE_REQUEST:w.TYPE_NOTIFY,o=this.data.protos?this.data.protos.client:{};r=o[t]?K.encode(t,r):E.strencode(JSON.stringify(r));var a=0;this.dict&&this.dict[t]&&(t=this.dict[t],a=1),r=w.encode(e,n,a,t,r);var i=P.encode(P.TYPE_DATA,r);this.send(i)},V.send=function(e){this.socket.send(e.buffer)},V.heartbeat=function(e){if(this.heartbeatInterval){var t=P.encode(P.TYPE_HEARTBEAT);if(this.heartbeatTimeoutId&&(clearTimeout(this.heartbeatTimeoutId),this.heartbeatTimeoutId=null),!this.heartbeatId){var r=this;this.heartbeatId=setTimeout(function(){r.heartbeatId=null,r.send(t),r.nextHeartbeatTimeout=Date.now()+r.heartbeatTimeout,r.heartbeatTimeoutId=setTimeout(r.heartbeatTimeoutCb.bind(r),r.heartbeatTimeout)},this.heartbeatInterval)}}},V.heartbeatTimeoutCb=function(){var e=this.nextHeartbeatTimeout-Date.now();e>this.gapThreshold?this.heartbeatTimeoutId=setTimeout(this.heartbeatTimeoutCb.bind(this),e):(console.error("server heartbeat timeout"),this.emit("heartbeat timeout"),this.disconnect())},V.handshake=function(e){if(e=JSON.parse(E.strdecode(e)),e.code===z)return void this.emit("error","client version not fullfill");if(e.code!==j)return void this.emit("error","handshake fail");this.handshakeInit(e);var t=P.encode(P.TYPE_HANDSHAKE_ACK);this.send(t),this.initCallback&&(this.initCallback(e),this.initCallback=null)},V.onData=function(e){var t=w.decode(e);t.id>0&&(t.route=this.routeMap[t.id],delete this.routeMap[t.id],!t.route)||(t.body=this.deCompose(t),this.processMessage(V,t))},V.onKick=function(e){this.emit("onKick")},V.processPackage=function(e){this.handlers[e.type].apply(this,[e.body])},V.processMessage=function(e,t){if(!t.id)return void this.emit(t.route,t.body);var r=this.callbacks[t.id];delete this.callbacks[t.id],"function"==typeof r&&r(t.body)};V.deCompose=function(e){var t=this.data.protos?this.data.protos.server:{},r=this.data.abbrs,n=e.route;if(e.compressRoute){if(!r[n])return{};n=e.route=r[n]}return t[n]?K.decode(n,e.body):JSON.parse(E.strdecode(e.body))},V.handshakeInit=function(e){e.sys&&e.sys.heartbeat?(this.heartbeatInterval=1e3*e.sys.heartbeat,this.heartbeatTimeout=2*this.heartbeatInterval):(this.heartbeatInterval=0,this.heartbeatTimeout=0),this.initData(e),"function"==typeof this.handshakeCallback&&this.handshakeCallback(e.user)},V.initData=function(e){if(e&&e.sys){this.data=e||{};var t=e.sys.dict,r=e.sys.protos;if(t){e.dict=t,e.abbrs={};for(var n in t)e.abbrs[t[n]]=n}r&&(e.protos={server:r.server||{},client:r.client||{}},this.protobuf&&this.protobuf.init({encoderProtos:r.client,decoderProtos:r.server}))}}}(window,Uint8Array);